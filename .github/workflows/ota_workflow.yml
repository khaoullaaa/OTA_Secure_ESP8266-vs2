name: Build and Release Firmware

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version tag
        id: version
        run: |
          # Get the latest tag, or start at v1.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"
          
          # Extract version numbers
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          # Auto-increment patch version
          PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          
          echo "New version: $NEW_VERSION"
          echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # Create and push the tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag $NEW_VERSION
          git push origin $NEW_VERSION

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      - name: Install ESP8266 platform and libraries
        run: |
          arduino-cli config init --additional-urls http://arduino.esp8266.com/stable/package_esp8266com_index.json
          arduino-cli core update-index
          arduino-cli core install esp8266:esp8266
          arduino-cli lib install ArduinoJson

      - name: Set version in sketch
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          sed -i "s/#define FW_VERSION_STR \"v0.0.0\"/#define FW_VERSION_STR \"${VERSION}\"/" OTA_Secure/OTA_Secure.ino
          echo "Building version: $VERSION"

      - name: Compile firmware
        run: |
          mkdir -p firmware_build
          arduino-cli compile \
            --fqbn esp8266:esp8266:nodemcuv2 \
            --output-dir firmware_build \
            OTA_Secure

      - name: Normalize firmware name
        run: |
          ls -la firmware_build
          if [ -f firmware_build/OTA_Secure.ino.bin ]; then
            mv firmware_build/OTA_Secure.ino.bin firmware_build/firmware.bin
          elif [ -f firmware_build/OTA_Secure.bin ]; then
            mv firmware_build/OTA_Secure.bin firmware_build/firmware.bin
          else
            echo "ERROR: firmware output not found" >&2
            exit 1
          fi

      - name: Generate SHA256
        run: |
          cd firmware_build
          SHA256=$(sha256sum firmware.bin | awk '{print $1}')
          echo "SHA256=$SHA256" >> $GITHUB_ENV
          echo "$SHA256" > sha256.txt

      - name: Create release manifest artifact
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          cd firmware_build
          cat > manifest.json << EOF
          {
            "version": "${VERSION}",
            "firmware_url": "https://github.com/${{ github.repository }}/releases/download/${VERSION}/firmware.bin",
            "sha256": "${{ env.SHA256 }}"
          }
          EOF

      - name: Commit updated manifest to main
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git fetch origin main
          git checkout main
          cat > manifest.json << EOF
          {
            "version": "${VERSION}",
            "firmware_url": "https://github.com/${{ github.repository }}/releases/download/${VERSION}/firmware.bin",
            "sha256": "${{ env.SHA256 }}"
          }
          EOF
          git add manifest.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update manifest for ${VERSION} [skip ci]" || exit 0
          git push origin HEAD:main

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          files: |
            firmware_build/firmware.bin
            firmware_build/manifest.json
            firmware_build/sha256.txt
          generate_release_notes: true
          draft: false
          prerelease: false

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-build
          path: firmware_build/
