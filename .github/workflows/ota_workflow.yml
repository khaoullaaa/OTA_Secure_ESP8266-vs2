name: Build and Release Firmware

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from Arduino sketch
        id: version
        run: |
          # Extract version from sketch (looks for #define FW_VERSION_STR "vX.Y.Z")
          VERSION=$(grep '#define FW_VERSION_STR' OTA_Secure/OTA_Secure.ino | sed 's/.*"\(.*\)".*/\1/')
          echo "Version from sketch: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          # Create and push the tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag $VERSION -m "Release $VERSION" || echo "Tag already exists"
          git push origin $VERSION || echo "Tag already pushed"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      - name: Install ESP8266 platform and libraries
        run: |
          arduino-cli config init --additional-urls http://arduino.esp8266.com/stable/package_esp8266com_index.json
          arduino-cli core update-index
          arduino-cli core install esp8266:esp8266
          arduino-cli lib install ArduinoJson

      - name: Display version
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "Building firmware version: $VERSION"

      - name: Compile firmware
        run: |
          mkdir -p firmware_build
          arduino-cli compile \
            --fqbn esp8266:esp8266:nodemcuv2 \
            --output-dir firmware_build \
            OTA_Secure

      - name: Normalize firmware name
        run: |
          ls -la firmware_build
          if [ -f firmware_build/OTA_Secure.ino.bin ]; then
            mv firmware_build/OTA_Secure.ino.bin firmware_build/firmware.bin
          elif [ -f firmware_build/OTA_Secure.bin ]; then
            mv firmware_build/OTA_Secure.bin firmware_build/firmware.bin
          else
            echo "ERROR: firmware output not found" >&2
            exit 1
          fi

      - name: Generate SHA256 of original firmware
        run: |
          cd firmware_build
          # Calculate SHA256 of UNENCRYPTED firmware (this is what ESP8266 verifies)
          SHA256=$(sha256sum firmware.bin | awk '{print $1}')
          echo "SHA256=$SHA256" >> $GITHUB_ENV
          echo "$SHA256" > sha256.txt
          echo "Original firmware SHA256: $SHA256"
      
      - name: Install Python dependencies for encryption
        run: |
          pip install pycryptodome
      
      - name: Encrypt firmware with AES-256
        run: |
          cd firmware_build
          # Encrypt firmware.bin -> firmware.bin.encrypted
          python3 ../encrypt_firmware.py firmware.bin firmware.bin.encrypted
          
          # Replace original with encrypted version
          mv firmware.bin firmware.bin.original
          mv firmware.bin.encrypted firmware.bin
          
          echo "Encrypted firmware size: $(stat -c%s firmware.bin) bytes"

      - name: Create release manifest artifact
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          cd firmware_build
          cat > manifest.json << EOF
          {
            "version": "${VERSION}",
            "firmware_url": "https://github.com/${{ github.repository }}/releases/download/${VERSION}/firmware.bin",
            "sha256": "${{ env.SHA256 }}",
            "encrypted": true,
            "encryption": "AES-256-CBC"
          }
          EOF

      - name: Commit updated manifest to main
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git fetch origin main
          git checkout main
          
          # Pull any changes first to avoid conflicts
          git pull --rebase origin main || true
          
          cat > manifest.json << EOF
          {
            "version": "${VERSION}",
            "firmware_url": "https://github.com/${{ github.repository }}/releases/download/${VERSION}/firmware.bin",
            "sha256": "${{ env.SHA256 }}",
            "encrypted": true,
            "encryption": "AES-256-CBC"
          }
          EOF
          git add manifest.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update manifest for ${VERSION} [skip ci]" || exit 0
          git push origin HEAD:main

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          files: |
            firmware_build/firmware.bin
            firmware_build/manifest.json
            firmware_build/sha256.txt
          generate_release_notes: true
          draft: false
          prerelease: false

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-build
          path: firmware_build/
