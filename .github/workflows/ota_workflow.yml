name: Build and Release Firmware

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "VERSION=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: v${VERSION}"

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      - name: Install ESP8266 platform and libraries
        run: |
          arduino-cli config init --additional-urls http://arduino.esp8266.com/stable/package_esp8266com_index.json
          arduino-cli core update-index
          arduino-cli core install esp8266:esp8266
          arduino-cli lib install ArduinoJson

      - name: Set version in sketch
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          sed -i "s/#define FW_VERSION_STR \"v0.0.0\"/#define FW_VERSION_STR \"${VERSION}\"/" OTA_Secure/OTA_Secure.ino

      - name: Compile firmware
        run: |
          mkdir -p firmware_build
          arduino-cli compile \
            --fqbn esp8266:esp8266:nodemcuv2 \
            --output-dir firmware_build \
            OTA_Secure

      - name: Normalize firmware name
        run: |
          ls -la firmware_build
          if [ -f firmware_build/OTA_Secure.ino.bin ]; then
            mv firmware_build/OTA_Secure.ino.bin firmware_build/firmware.bin
          elif [ -f firmware_build/OTA_Secure.bin ]; then
            mv firmware_build/OTA_Secure.bin firmware_build/firmware.bin
          else
            echo "ERROR: firmware output not found" >&2
            exit 1
          fi

      - name: Generate SHA256
        run: |
          cd firmware_build
          SHA256=$(sha256sum firmware.bin | awk '{print $1}')
          echo "SHA256=$SHA256" >> $GITHUB_ENV

      - name: Create manifests
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p firmware_build
          cat > firmware_build/manifest.json << EOF
          {
            "version": "${VERSION}",
            "firmware_url": "https://github.com/${{ github.repository }}/releases/download/${VERSION}/firmware.bin",
            "sha256": "${{ env.SHA256 }}"
          }
          EOF
          cp firmware_build/manifest.json manifest.json

      - name: Create git tag
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${VERSION} -m "Release ${VERSION}" 2>/dev/null || echo "Tag exists"
          git push origin ${VERSION} 2>/dev/null || echo "Tag already pushed"

      - name: Update manifest in main
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git fetch origin main
          git checkout main
          cat > manifest.json << EOF
          {
            "version": "${VERSION}",
            "firmware_url": "https://github.com/${{ github.repository }}/releases/download/${VERSION}/firmware.bin",
            "sha256": "${{ env.SHA256 }}"
          }
          EOF
          git add manifest.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update manifest for ${VERSION}" || true
          git push origin main

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          files: |
            firmware_build/firmware.bin
            firmware_build/manifest.json
          generate_release_notes: true
          draft: false
          prerelease: false

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-build
          path: firmware_build/
